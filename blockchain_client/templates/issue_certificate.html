<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Issue Certificate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-3 p-md-4">
  <main class="container">
    <h1 class="h3 mb-3">Issue Certificate</h1>
    <p class="text-muted">Hash the transcript locally, then record the hash on-chain.</p>
    <hr class="mb-4">

    <div class="mb-3">
      <label for="node" class="form-label">Node URL</label>
      <input id="node" name="node" type="url" class="form-control" value="{{ node }}" placeholder="http://127.0.0.1:5001">
    </div>

    <div class="mb-3">
      <label for="pubkey" class="form-label">Your Public Key (issuer)</label>
      <textarea id="pubkey" class="form-control" rows="6" readonly>{{ sender_public_key }}</textarea>
    </div>

    <div class="mb-3">
      <label for="file" class="form-label">Transcript file (PDF/PNG)</label>
      <input id="file" name="file" type="file" class="form-control">
      <div class="form-text">We compute SHA-256 locally; the file is not uploaded to the node.</div>
    </div>

    <div class="mb-3">
      <label for="doc_hash" class="form-label">Computed SHA-256</label>
      <input id="doc_hash" name="doc_hash" type="text" class="form-control" placeholder="Click ‘Hash File’ to fill">
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <label for="issuer_id" class="form-label">Issuer ID</label>
        <input id="issuer_id" name="issuer_id" type="text" class="form-control" placeholder="OTU_REGISTRAR">
      </div>
      <div class="col-md-6">
        <label for="student_ref" class="form-label">Student Ref (anonymized)</label>
        <input id="student_ref" name="student_ref" type="text" class="form-control" placeholder="s12345 or hash">
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-6">
        <label for="program" class="form-label">Program</label>
        <input id="program" name="program" type="text" class="form-control" placeholder="BSc Computer Science">
      </div>
      <div class="col-md-6">
        <label for="issue_date" class="form-label">Issue Date</label>
        <input id="issue_date" name="issue_date" type="text" class="form-control" placeholder="2025-05-01">
      </div>
    </div>

    <div class="row g-3 mt-1">
      <div class="col-md-6">
        <label for="recipient_address" class="form-label">Recipient Address (optional)</label>
        <input id="recipient_address" name="recipient_address" type="text" class="form-control" value="NONE">
      </div>
      <div class="col-md-6">
        <label for="nonce" class="form-label">Nonce (issuer counter)</label>
        <input id="nonce" name="nonce" type="number" class="form-control" value="1" min="1">
      </div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="btnHash" type="button" class="btn btn-secondary">Hash File</button>
      <button id="btnIssue" type="button" class="btn btn-primary">Issue Certificate</button>
      <a class="btn btn-outline-dark" href="/">Home</a>
    </div>

    <pre id="result" class="bg-light border rounded mt-3 p-2" aria-live="polite"></pre>
  </main>

  <script>
    const nodeInput = document.getElementById('node');
    const fileInput = document.getElementById('file');
    const outHash = document.getElementById('doc_hash');
    const result = document.getElementById('result');

    document.getElementById('btnHash').addEventListener('click', async () => {
      result.textContent = 'Hashing...';
      const f = fileInput.files[0];
      if (!f) { result.textContent = 'Pick a file first.'; return; }
      const fd = new FormData(); fd.append('file', f);
      const r = await fetch('/hash_file', { method:'POST', body: fd });
      const j = await r.json();
      if (j.ok) { outHash.value = j.sha256; result.textContent = 'SHA-256 computed.'; }
      else { result.textContent = 'Error: ' + (j.error || 'unknown'); }
    });

    document.getElementById('btnIssue').addEventListener('click', async () => {
      result.textContent = 'Submitting transaction...';
      const p = new URLSearchParams();
      p.set('node', nodeInput.value.trim());
      p.set('doc_hash', document.getElementById('doc_hash').value.trim());
      p.set('issuer_id', document.getElementById('issuer_id').value.trim());
      p.set('student_ref', document.getElementById('student_ref').value.trim());
      p.set('program', document.getElementById('program').value.trim());
      p.set('issue_date', document.getElementById('issue_date').value.trim());
      p.set('recipient_address', document.getElementById('recipient_address').value.trim());
      p.set('nonce', document.getElementById('nonce').value.trim());
      const r = await fetch('/issue_certificate', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p });
      const html = await r.text(); document.open(); document.write(html); document.close();
    });
  </script>
</body>
</html>
